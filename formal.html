<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>Winter Formal</title>

    <!-- Open Graph meta tags for social media preview -->
    <meta property="og:title" content="Winter Formal">
    <meta property="og:description" content="Join us for Winter Formal - an exclusive invite-only event">
    <meta property="og:image" content="image-banner.png">
    <meta property="og:url" content="">
    <meta property="og:type" content="website">

    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Winter Formal">
    <meta name="twitter:description" content="Join us for Winter Formal - an exclusive invite-only event">
    <meta name="twitter:image" content="image-banner.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Literata:ital,opsz,wght@0,7..72,200..900;1,7..72,200..900&display=swap" rel="stylesheet">
    
    <link rel="apple-touch-icon" sizes="180x180" href="favicons5/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicons5/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicons5/favicon-16x16.png">
    <link rel="manifest" href="favicons5/site.webmanifest">
    
    <style>
        :root {
            --dark-blue:#0a1c2c;/*#013426;dark gree*/
            --white: #ffffff;
        }

        ::selection {
            background-color: white;
            color: var(--dark-blue);
        }

        ::-moz-selection {
            background-color: white;
            color: var(--dark-blue);
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--dark-blue);
            font-family: "Inter", sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .app-container {
            width: 100%;
            max-width: 400px;
            min-height: 100vh;
            position: relative;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            padding-top: 30px;
            box-sizing: border-box;
           
        }

        /* App container inside fixed screens should use height instead of min-height */
        [class*="-screen"] .app-container {
            min-height: 0;
            height: 100%;
        }

        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('noise-light.png');
            background-repeat: repeat;
            opacity: 0.3;
            pointer-events: none;
            z-index: 1;
        }

        .container {
            text-align: center;
            max-width: 100%;
            padding: 20px 15px;
            position: relative;
            z-index: 10;
            width: 100%;
            box-sizing: border-box;
        }

        .invite-text {
            font-family: "Literata", serif;
            font-size: 24px;
            color: white;
            line-height: 1.3;
            margin-bottom: 20px;
        }

        .first-page-button {

            padding: 12px 0px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: "Inter", sans-serif;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            width: 100%;

        }

        .primary-button {
            background-color: white;
            color: var(--dark-blue);
            border: none;
            padding: 12px 0px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid white;
            margin-left: auto;
 
        }

        .secondary-button {
            background-color: transparent;
            color: white;
            border: 1px solid white;
            margin: auto;
            margin-bottom: 15px;
        }
        .first-page-button:hover {
           /*slide up 1 px*/
           transform: translateY(-1px);
        }

        .subtitle {
            font-family: "Inter", sans-serif;
            font-size: 13px;
            color: white;
            line-height: 1.4;
            opacity: 0.9;
            font-style: italic;
            margin-bottom: 20px;
        }

        /* Pricing Screen Styles */
        .pricing-screen {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-blue);
            overflow-y: auto;
        }

        .pricing-container {
            text-align: center;
            max-width: 100%;
            padding: 20px 15px;
            position: relative;
            z-index: 10;
            margin: 0 auto;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
        }

        .pricing-text {
            font-family: "Literata", serif;
            font-size: 28px;
            color: white;
            line-height: 1.3;
            margin-bottom: 20px;
        }

        .pricing-details {
            font-family: "Inter", sans-serif;
            font-size: 14px;
            color: white;
            line-height: 1.4;
            margin-bottom: 30px;
            opacity: 0.9;
            font-style: italic;
            padding: 0 10px;
        }

        .pricing-disclaimer {
            font-family: "Inter", sans-serif;
            font-size: 14px;
            color: white;
            line-height: 1.4;
            opacity: 0.8;
            font-style: italic;
            margin-bottom: 40px;
        }

        .couple-ticket-button {
            background-color: white;
            color: var(--dark-blue);
            border: none;
            padding: 12px 0px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: "Inter", sans-serif;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .couple-ticket-button:hover {
            transform: translateY(-1px);
        }

        .single-ticket-button {
            background-color: transparent;
            color: white;
            border: 1px solid white;
            padding: 12px 0px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: "Inter", sans-serif;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .single-ticket-button:hover {
            transform: translateY(-1px);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .back-button {
            background-color: transparent;
            color: white;
            border: none;
            padding: 8px 20px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-family: "Inter", sans-serif;
            transition: all 0.3s ease;
            opacity: 0.8;
            text-decoration: none;
            margin-bottom: 20px;
        }

        .back-button:hover {
            opacity: 1;
        }

        /* How To Pay Screen Styles */
        .how-to-pay-screen {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-blue);
            overflow-y: auto;
        }

        .how-to-pay-container {
            text-align: center;
            max-width: 100%;
            padding: 20px 15px;
            position: relative;
            z-index: 10;
            margin: 0 auto;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
        }

        .how-to-pay-title {
            font-family: "Literata", serif;
            font-size: 28px;
            color: white;
            line-height: 1.3;
            margin-bottom: 20px;
        }

        .how-to-pay-disclaimer {
            font-family: "Inter", sans-serif;
            font-size: 14px;
            color: white;
            line-height: 1.4;
            opacity: 0.8;
            font-style: italic;
            margin-bottom: 30px;
            padding: 0 15px;
        }

        .how-to-pay-disclaimer a {
            color: white;
            text-decoration: underline;
        }

        .how-to-pay-disclaimer a:hover {
            opacity: 0.7;
        }

        .how-to-pay-steps {
            font-family: "Inter", sans-serif;
            font-size: 16px;
            color: white;
            line-height: 1.6;
            margin-bottom: 30px;
            opacity: 0.9;
            text-align: left;
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
        }

        .how-to-pay-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .how-to-pay-step:last-child {
            margin-bottom: 0;
        }

        .how-to-pay-step-number {
            background-color: white;
            color: var(--dark-blue);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 15px;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .how-to-pay-step-content {
            flex: 1;
        }

        .how-to-pay-step-title {
            font-size: 14px;
            font-weight: bold;
            color: white;
            margin: 0 0 5px 0;
        }

        .how-to-pay-step-description {
            font-size: 12px;
            color: white;
            margin: 0;
            line-height: 1.4;
            opacity: 0.8;
        }

        .how-to-pay-button {
            background-color: white;
            color: var(--dark-blue);
            border: none;
            padding: 12px 0px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: "Inter", sans-serif;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            width: 100%;
        }

        .how-to-pay-button:hover {
            transform: translateY(-1px);
        }

        .how-to-pay-button.secondary {
            background-color: transparent;
            color: white;
            border: 1px solid white;
            margin-bottom: 20px;
        }

        .how-to-pay-button.secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .copy-box-share-link {
            margin-bottom: 0;
        }

        /* Complete Payment Screen Styles */
        .complete-payment-screen {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-blue);
            overflow-y: auto;
        }

        .complete-payment-container {
            text-align: center;
            max-width: 100%;
            padding: 5px 15px;
            position: relative;
            z-index: 10;
            margin: 0 auto;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
        }

        .complete-payment-title {
            font-family: "Literata", serif;
            font-size: 28px;
            color: white;
            line-height: 1.3;
            margin-bottom: 20px;
        }

        .complete-payment-description {
            font-family: "Inter", sans-serif;
            font-size: 14px;
            color: white;
            line-height: 1.4;
            margin-bottom: 30px;
            opacity: 0.9;
            text-align: center;
            font-style: italic;
            padding: 0 15px;
        }

        .venmo-launch-button {
            background-color: white;
            color: var(--dark-blue);
            border: none;
            padding: 12px 60px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: "Inter", sans-serif;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            width: 100%;
            margin-top: 20px;
        }

        .venmo-launch-button:hover {
            transform: translateY(-1px);
        }

        .venmo-dropdown-container {
            text-align: center;
        }

        .venmo-dropdown-button {
            font-family: "Inter", sans-serif;
            font-size: 14px;
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            text-align: left;
        }

        .venmo-dropdown-button:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .venmo-dropdown-button span:first-child {
            flex: 1;
        }

        .dropdown-arrow {
            margin-left: 10px;
            font-size: 12px;
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }

        .venmo-dropdown-button.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .fallback-section {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            animation: slideDown 0.3s ease;
        }
        .fallback-section-venmo {
            margin-top: 20px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fallback-title {
            font-family: "Inter", sans-serif;
            font-size: 16px;
            color: white;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .fallback-text {
            font-family: "Inter", sans-serif;
            font-size: 14px;
            color: white;
            line-height: 1.4;
            margin-bottom: 15px;
            opacity: 0.9;
            text-align: center;
        }

        .copy-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .copy-box {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
        }

        .copy-box.simple {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 36px;
            padding: 8px 12px;
            line-height: 1.2;
        }

        .copy-box:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .copy-label {
            font-family: "Inter", sans-serif;
            font-size: 12px;
            color: white;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .copy-box.simple .copy-label {
            font-size: 14px;
            opacity: 0.9;
            margin: 0;
            line-height: 1.2;
        }

        .copy-content {
            font-family: "Inter", sans-serif;
            font-size: 12px;
            color: white;
            font-weight: 400;
            word-break: break-all;
            line-height: 1.4;
            opacity: 0.9;
        }

        .copy-feedback {
            font-family: "Inter", sans-serif;
            font-size: 12px;
            color: #4CAF50;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1.2;
        }

        .copy-feedback.show {
            opacity: 1;
        }

        .copy-content {
            transition: opacity 0.3s ease;
        }

        .copy-content.hidden {
            opacity: 0;
        }

        .copy-label {
            transition: opacity 0.3s ease;
        }

        .copy-label.hidden {
            opacity: 0 !important;
            pointer-events: none;
        }
        
        .copy-box.simple .copy-label.hidden {
            opacity: 0 !important;
            pointer-events: none;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-family: "Inter", sans-serif;
            font-size: 14px;
            font-weight: bold;
            color: white;
            margin-bottom: 8px;
            text-align: left;
        }

        .input-hint {
            font-family: "Inter", sans-serif;
            font-size: 12px;
            color: white;
            margin-top: 5px;
            opacity: 0.7;
            text-align: left;
        }

        /* Verification Screen Styles */
        .verification-screen {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-blue);
            overflow-y: auto;
        }

        .verification-container {
            text-align: center;
            max-width: 100%;
            padding: 20px 15px;
            position: relative;
            z-index: 10;
            margin: 0 auto;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
        }

        .verification-title {
            font-family: "Literata", serif;
            font-size: 28px;
            color: white;
            line-height: 1.3;
            margin-bottom: 20px;
        }

        .verification-description {
            font-family: "Inter", sans-serif;
            font-size: 14px;
            color: white;
            line-height: 1.4;
            margin-bottom: 30px;
            opacity: 0.9;
            text-align: center;
            font-style: italic;
            padding: 0 40px;
        }

        .verification-form-container {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            padding-bottom: 0;
            margin: 0 auto 30px auto;
            max-width: 320px;
            width: 100%;
            box-sizing: border-box;
        }

        .verification-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 16px;
            font-family: "Inter", sans-serif;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            box-sizing: border-box;
            transition: border-color 0.2s;
            text-align: center;
            letter-spacing: 2px;
        }

        .verification-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .verification-input:focus {
            outline: none;
            border-color: white;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
        }

        .verify-button {
            background-color: white;
            color: var(--dark-blue);
            border: none;
            padding: 12px 60px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: "Inter", sans-serif;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            width: 100%;
        }

        .verify-button:hover {
            transform: translateY(-1px);
        }

        .verify-button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        /* Error message styles */
        .error-message {
            color: white;
            font-family: "Inter", sans-serif;
            font-size: 14px;
            text-align: center;
            margin: 15px 0;
            padding: 10px 15px;
            padding-top: 0;
            margin-top: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .error-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Name Entry Screen Styles */
        .name-entry-screen {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-blue);
            overflow-y: auto;
        }

        .name-entry-container {
            text-align: center;
            max-width: 100%;
            padding: 20px 15px;
            position: relative;
            z-index: 10;
            margin: 0 auto;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
        }

        .name-entry-title {
            font-family: "Literata", serif;
            font-size: 28px;
            color: white;
            line-height: 1.3;
            margin-bottom: 20px;
        }

        .name-entry-description {
            font-family: "Inter", sans-serif;
            font-size: 14px;
            color: white;
            line-height: 1.4;
            margin-bottom: 30px;
            opacity: 0.9;
            text-align: center;
            font-style: italic;
            padding: 0 20px;
        }

        .name-form-container {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin: 0 auto 30px auto;
            max-width: 320px;
            width: 100%;
            box-sizing: border-box;
        }

        .name-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 16px;
            font-family: "Inter", sans-serif;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .name-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .name-input:focus {
            outline: none;
            border-color: white;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
        }

        .name-input:invalid {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .submit-name-button {
            background-color: white;
            color: var(--dark-blue);
            border: none;
            padding: 12px 60px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: "Inter", sans-serif;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            width: 100%;
        }

        .submit-name-button:hover {
            transform: translateY(-1px);
        }

        .submit-name-button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        /* Email Entry Screen Styles */
        .email-entry-screen {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-blue);
            overflow-y: auto;
        }

        .email-entry-container {
            text-align: center;
            max-width: 100%;
            padding: 20px 15px;
            position: relative;
            z-index: 10;
            margin: 0 auto;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
        }

        .email-entry-title {
            font-family: "Literata", serif;
            font-size: 28px;
            color: white;
            line-height: 1.3;
            margin-bottom: 20px;
        }

        .email-entry-description {
            font-family: "Inter", sans-serif;
            font-size: 14px;
            color: white;
            line-height: 1.4;
            margin-bottom: 30px;
            opacity: 0.9;
            text-align: center;
            font-style: italic;
            padding: 0 20px;
        }

        .email-form-container {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin: 0 auto 30px auto;
            max-width: 320px;
            width: 100%;
            box-sizing: border-box;
        }

        .email-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 16px;
            font-family: "Inter", sans-serif;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .email-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .email-input:focus {
            outline: none;
            border-color: white;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
        }

        .email-input:invalid {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .submit-email-button {
            background-color: white;
            color: var(--dark-blue);
            border: none;
            padding: 12px 60px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: "Inter", sans-serif;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            width: 100%;
        }

        .submit-email-button:hover {
            transform: translateY(-1px);
        }

        .submit-email-button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        /* Venmo Popup Styles */
        .venmo-popup-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000 !important;
            pointer-events: auto !important;
        }

        .venmo-popup {
            background-color: white;
            color: var(--dark-blue);
            padding: 33px;
            border-radius: 8px;
            width: 320px;
            height: auto;
            text-align: center;
            font-size: 16px;
            line-height: 1.4;
            box-sizing: border-box;
            position: relative !important;
            z-index: 2001 !important;
            pointer-events: auto !important;
        }

        .venmo-popup-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            color: var(--dark-blue);
        }

        .venmo-popup-text {
            margin-bottom: 20px;
        }

        .venmo-popup-button {
            background-color: var(--dark-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer !important;
            width: 100%;
            transition: opacity 0.2s, transform 0.1s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            pointer-events: auto !important;
            position: relative !important;
            z-index: 2002 !important;
        }

        .venmo-popup-button:hover {
            opacity: 0.9;
        }

        .venmo-popup-button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .venmo-popup-close {
            position: absolute !important;
            top: 20px;
            right: 20px;
            color: #999;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer !important;
            background: none;
            border: none;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            transition: opacity 0.2s;
            pointer-events: auto !important;
            z-index: 2002 !important;
        }

        .venmo-popup-close:hover {
            opacity: 0.7;
        }

        .venmo-popup-close:active {
            opacity: 0.5;
        }

        /* Payment Received Screen Styles */
        .payment-received-screen {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-blue);
            overflow-y: auto;
        }

        .payment-received-container {
            text-align: center;
            max-width: 100%;
            padding: 20px 15px;
            position: relative;
            z-index: 10;
            margin: 0 auto;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
        }

        .payment-received-title {
            font-family: "Literata", serif;
            font-size: 28px;
            color: white;
            line-height: 1.3;
            margin-bottom: 20px;
        }

        .payment-received-description {
            font-family: "Inter", sans-serif;
            font-size: 14px;
            color: white;
            line-height: 1.4;
            margin-bottom: 30px;
            opacity: 0.9;
            text-align: center;
            font-style: italic;
            padding: 0 10px;
        }

        .view-ticket-button {
            background-color: white;
            color: var(--dark-blue);
            border: none;
            padding: 12px 60px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: "Inter", sans-serif;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            width: 100%;
        }

        .view-ticket-button:hover {
            transform: translateY(-1px);
        }

        .view-ticket-test-button {
            background-color: transparent;
            color: white;
            border: 1px solid white;
            padding: 12px 60px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: "Inter", sans-serif;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            width: 100%;
        }

        .view-ticket-test-button:hover {
            transform: translateY(-1px);
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Loading Screen Styles */
        .loading-screen {
            display: block;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-blue);
        }

        /* Mobile Detection Screen Styles */
        .mobile-detection-screen {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--light-green) 100%);
            overflow-y: auto;
        }

        .mobile-detection-container {
            text-align: center;
            max-width: 100%;
            padding: 20px 15px;
            position: relative;
            z-index: 10;
            margin: 0 auto;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }

        .mobile-detection-title {
            font-family: "Literata", serif;
            font-size: 28px;
            color: white;
            line-height: 1.3;
            margin-bottom: 30px;
            margin-top: 0;
        }

        .mobile-detection-description {
            font-family: "Inter", sans-serif;
            font-size: 16px;
            color: white;
            line-height: 1.4;
            margin-bottom: 30px;
            opacity: 0.9;
            text-align: center;
        }

        .qr-code-container {
            margin: 20px auto;
            max-width: 200px;
            min-height: 200px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-code-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            max-width: 180px;
        }

        .qr-code-placeholder {
            color: white;
            font-size: 14px;
            opacity: 0.7;
            text-align: center;
        }

        .mobile-link {
            font-family: "Inter", sans-serif;
            font-size: 14px;
            color: white;
            margin-top: 20px;
            display: inline-block;
            font-style: italic;
        }

        /* Pay For Other Screen Styles */
        .pay-for-other-screen {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-blue);
            overflow-y: auto;
        }

    </style>
</head>
<body>
    <!-- Mobile Detection Screen -->
    <div id="mobileDetectionScreen" class="mobile-detection-screen">
        <div class="noise-overlay"></div>
        <div class="mobile-detection-container">
            <div class="mobile-detection-title">
                Please continue on your phone
            </div>
            <div class="qr-code-container">
                <img src="qr-code-mobile-winter-1.png" alt="QR Code" class="qr-code-image" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div class="qr-code-placeholder" style="display: none;">QR Code: Scan to open on mobile</div>
            </div>
            <div class="mobile-link">
                Scan the QR code above to continue on your mobile device.
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="noise-overlay"></div>
    </div>

    <div class="app-container" style="display: none;">
        <div class="noise-overlay"></div>
        
        <div class="container">
            <div class="invite-text">
                You're invited to the Duncan Off-Campus Winter Formal ❄️
            </div>
            <div class="subtitle">
            </div>
            <button class="first-page-button primary-button" id="rsvpYes">RSVP: Yes, I will be attending</button>
          
        </div>
    </div>

    <!-- Pricing Screen -->
    <div id="pricingScreen" class="pricing-screen">
        <div class="app-container">
            <div class="noise-overlay"></div>
            <div class="pricing-container">
                <div class="pricing-text">
                    Select Your Ticket
                </div>
                <div class="pricing-details">
                </div>

                <button class="couple-ticket-button" id="coupleTicketBtn">Couple -  8 Drinks ($15)</button>
                <button class="single-ticket-button" id="singleTicketBtn">Single - 4 Drinks ($7)</button>
                <button class="back-button" id="backButton">Back</button>
            </div>
        </div>
    </div>

    <!-- Name Entry Screen -->
    <div id="nameEntryScreen" class="name-entry-screen">
        <div class="app-container">
            <div class="noise-overlay"></div>
            <div class="name-entry-container">
                <div class="name-entry-title">
                    Enter Your Name
                </div>
                <div class="name-entry-description">
                    This will be the name on your one ticket that you (and your date) will use, as well as the name that appears on the public RSVP list. (RSVP list will be linked on your ticket).
                </div>
                <div class="name-form-container">
                    <form id="nameForm" onsubmit="handleNameSubmit(event)">
                        <div class="input-group">
                            <label for="fullName"  class="input-label">Full Name</label>
                            <input 
                                type="text" 
                                id="fullName" 
                                name="fullName" 
                                class="name-input" 
                                placeholder="Enter your full name"
                                value="Will Sullivan"
                                required
                                minlength="2"
                                maxlength="50"
                                autocomplete="name"
                            >
                            <div class="input-hint">Enter your first and last name</div>
                        </div>
                    </form>
                </div>
                
                <button type="submit" form="nameForm" class="submit-name-button" id="submitNameButton" disabled>Continue</button>
                <button class="back-button" id="backFromNameEntry">Back</button>
            </div>
        </div>
    </div>

    <!-- Email Entry Screen -->
    <div id="emailEntryScreen" class="email-entry-screen">
        <div class="app-container">
            <div class="noise-overlay"></div>
            <div class="email-entry-container">
                <div class="email-entry-title">
                    Enter Your Email
                </div>
                <div class="email-entry-description">
                    Your ticket will be sent to this email address. Please use your ND email so we can track who has and has not accepted their invitation.
                </div>
                
                <div class="email-form-container">
                    <form id="emailForm" onsubmit="handleEmailSubmit(event)">
                        <div class="input-group">
                            <label for="emailAddress" class="input-label">ND Email Address</label>
                            <input 
                                type="email" 
                                id="emailAddress" 
                                name="emailAddress" 
                                class="email-input" 
                                placeholder="netid@nd.edu"
                                value="wsulli22@nd.edu"
                                required
                                autocomplete="email"
                            >
                        </div>
                    </form>
                </div>
                
                <div id="emailErrorMessage" class="error-message"></div>
                
                <button type="submit" form="emailForm" class="submit-email-button" id="submitEmailButton" disabled>Continue</button>
                <button class="back-button" id="backFromEmailEntry">Back</button>
            </div>
        </div>
    </div>

    <!-- Verification Screen -->
    <div id="verificationScreen" class="verification-screen">
        <div class="app-container">
            <div class="noise-overlay"></div>
            <div class="verification-container">
                <div class="verification-title">
                    Enter Verification Code
                </div>
                <div class="verification-description" id="verificationDescription">
                    We sent a code to your phone number
                </div>
                
                <div class="verification-form-container">
                    <form id="verificationForm" onsubmit="handleVerificationSubmit(event)">
                        <div class="input-group">
                            <label for="verificationCode" class="input-label">Verification Code</label>
                            <input 
                                type="text" 
                                id="verificationCode" 
                                name="verificationCode" 
                                class="verification-input" 
                                placeholder="000000"
                                value=""
                                required
                                pattern="[0-9]{6}"
                                maxlength="6"
                                inputmode="numeric"
                                autocomplete="one-time-code"
                                data-form-type="other"
                            >
                        </div>
                    </form>
                </div>
                
                <div id="verificationErrorMessage" class="error-message"></div>
                
                <button type="submit" form="verificationForm" class="verify-button" id="verifyButton" disabled>Verify Code</button>
                <button class="back-button" id="backFromVerification">Back</button>
            </div>
        </div>
    </div>

    <!-- How To Pay Screen -->
    <div id="howToPayScreen" class="how-to-pay-screen">
        <div class="app-container">
            <div class="noise-overlay"></div>
            <div class="how-to-pay-container">
                <div class="how-to-pay-title">
                 Use Venmo To Pay
                </div>
                <div class="how-to-pay-disclaimer">
                    All tickets must be paid for through Venmo, with no exceptions. If you don’t have Venmo, please use someone you know who does to submit your payment.
                </div>
                <button class="how-to-pay-button" id="proceedToPayment">I'm Paying With Venmo</button>
                <button class="how-to-pay-button secondary" id="someonePayingForMeButton" onclick="toggleSomeonePayingForMe()">
                    Someone is Venmoing On My Behalf
                </button>
                <div class="fallback-section" id="someonePayingForMeSection" style="display: none;">
                    <div class="fallback-title" style="margin-bottom: 12px; font-size: 14px;">Share the link below with the person paying on your behalf. Once you share the link, you're all done. Your ticket will be emailed to you once the person's Venmo payment is confirmed.</div>
                    <div class="copy-box simple copy-box-share-link" onclick="copyToClipboard(getShareLink(), this)" id="copyLinkBox">
                        <div class="copy-label" style="line-height: 1.2;">Click to Copy Payment Link</div>
                        <div class="copy-feedback" style="line-height: 1.2;">Link Copied</div>
                    </div>
                </div>
                
                <button class="back-button" id="backFromHowToPay">Back</button>
            </div>
        </div>
    </div>

    <!-- Pay For Other Screen -->
    <div id="payForOtherScreen" class="pay-for-other-screen">
        <div class="app-container">
            <div class="noise-overlay"></div>
            <div class="how-to-pay-container">
                <div class="how-to-pay-title" id="payForOtherTitle">
                    You're Paying for <br>[Name]'s Ticket
                </div>
                <div class="verification-form-container" style="margin-top: 20px;">
                    <div class="input-group" style="margin-bottom: 15px;">
                        <div class="input-label">Name on Ticket</div>
                        <div class="fallback-text" style="text-align: left; margin-top: 5px;" id="payForOtherName"></div>
                    </div>
                    <div class="input-group" style="margin-bottom: 15px;">
                        <div class="input-label">Ticket Type</div>
                        <div class="fallback-text" style="text-align: left; margin-top: 5px;" id="payForOtherTicketType"></div>
                    </div>
                    <div class="input-group">
                        <div class="input-label">Ticket Will Be Sent To</div>
                        <div class="fallback-text" style="text-align: left; margin-top: 5px;" id="payForOtherEmail"></div>
                    </div>
                </div>
                <button class="how-to-pay-button" id="payForOtherNow">Pay Now With Venmo</button>
            </div>
        </div>
    </div>

    <!-- Complete Payment Screen -->
    <div id="completePaymentScreen" class="complete-payment-screen">
        <div class="app-container">
            <div class="noise-overlay"></div>
            <div class="complete-payment-container">
                <div class="complete-payment-title">
                    Complete Your Payment
                </div>
                <div class="complete-payment-description" id="completePaymentDescription">
                </div>
                
                <div class="how-to-pay-steps">
                    <div class="how-to-pay-step">
                        <span class="how-to-pay-step-number">1</span>
                        <div class="how-to-pay-step-content">
                            <div class="how-to-pay-step-title">Click to launch Venmo</div>
                            <div class="how-to-pay-step-description">We'll open the Venmo app for you.</div>
                        </div>
                    </div>
                    <div class="how-to-pay-step">
                        <span class="how-to-pay-step-number">2</span>
                        <div class="how-to-pay-step-content">
                            <div class="how-to-pay-step-title">Do not modify the pre-populated Venmo amount or the order number in the note</div>
                            <div class="how-to-pay-step-description">Keep the auto-filled fields as they are.</div>
                        </div>
                    </div>
                    <div class="how-to-pay-step">
                        <span class="how-to-pay-step-number">3</span>
                        <div class="how-to-pay-step-content">
                            <div class="how-to-pay-step-title">Receive your ticket via email</div>
                            <div class="how-to-pay-step-description">We'll send the ticket once we confirm your Venmo payment. <strong><u>REMEMBER TO CHECK YOUR SPAM.</u></strong></div>
                        </div>
                    </div>
                </div>
                
                <div class="venmo-dropdown-container">
                    <button class="venmo-dropdown-button" id="venmoFallbackLink" onclick="toggleVenmoFallback()">
                        <span>If the Venmo app doesn't open or gets popup blocked, come back and click here for additional instructions.</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                </div>
                <div class="fallback-section fallback-section-venmo" id="fallbackSection" style="display: none;">
                    <div class="fallback-title">In the event Venmo does not open:</div>
                    <div class="fallback-text" id="fallbackText">
                        Venmo $10 to @DuncanOffCampus <br>with message "Winter Formal (#42821)". Remember to click "Pay Without Confirming" or enter "6796" if Venmo asks you for the last 4 digits of the phone number.
                    </div>
                    <div class="copy-section">
                        <div class="copy-box" onclick="copyToClipboard('duncanoffcampus', this)">
                            <div class="copy-label">Venmo Username (click to copy)</div>
                            <div class="copy-content">@DuncanOffCampus</div>
                            <div class="copy-feedback">Venmo Username Copied</div>
                        </div>
                        <div class="copy-box" onclick="copyToClipboard(getVenmoMessage(), this)">
                            <div class="copy-label">Venmo Message (click to copy)</div>
                            <div class="copy-content" id="venmoMessageContent">Winter Formal (#42821)</div>
                            <div class="copy-feedback">Venmo Message Copied</div>
                        </div>
                    </div>
                </div>
                
                <button class="venmo-launch-button" id="launchVenmo">Launch Venmo</button>
                <button class="back-button" id="backFromCompletePayment">Back</button>
            </div>
        </div>
    </div>

    <!-- Venmo Popup -->
    <div class="venmo-popup-overlay" id="venmoPopupOverlay">
        <div class="venmo-popup">
            <button class="venmo-popup-close" id="venmoPopupClose" onclick="closeVenmoPopup(); return false;">&times;</button>
            <div class="venmo-popup-title">IMPORTANT NOTE</div>
            <div class="venmo-popup-text">Click "Pay Without Confirming" or enter "6796" if Venmo asks you for the last 4 digits of the phone number</div>
            <button class="venmo-popup-button" id="venmoPopupButton" onclick="closeVenmoPopup(); launchVenmoApp(); return false;">GOT IT. TAKE ME TO VENMO</button>
        </div>
    </div>

    <!-- Payment Received Screen -->
    <div id="paymentReceivedScreen" class="payment-received-screen">
        <div class="app-container">
            <div class="noise-overlay"></div>
            <div class="payment-received-container">
                <div class="payment-received-title">
                    Payment Received
                </div>
                <div class="payment-received-description">
                    View your ticket below. It was also texted to you.
                </div>
                
                <button class="view-ticket-button" id="viewTicketButton">View Your Ticket</button>
            </div>
        </div>
    </div>

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase configuration
        const SUPABASE_URL = "https://razsrkcvecymujfmrzev.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhenNya2N2ZWN5bXVqZm1yemV2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTIwNzAzNCwiZXhwIjoyMDcwNzgzMDM0fQ.oP2KHilItRH1EZ53-eOY_Ihcyt0Kn-paa1U-jAZnUgo";
        

        const SKIP_OTP = true;

        
        // Configuration flags

        //DON'T CHANGE THIS ONE˜
        const SEND_TICKET_TEXT = false; // Set to false to disable automatic SMS sending
        
        // Mobile detection - boolean value that runs off the requirement for mobile only
        const IS_MOBILE_DEVICE = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // Override mobile device popup - set to true to bypass the "continue on mobile device" popup
        const OVERRIDE_MOBILE_POPUP = true;
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Skip OTP verification - set to "true" to bypass SMS verification
        
        // Track ticket type for Venmo amount
        let selectedTicketType = 'single'; // 'single' or 'couple'
        let ticketAmount = 10; // Default to single ticket amount
        let coupleTicketPrice = 15; // Default couple ticket price
        let singleTicketPrice = 10; // Default single ticket price
        let coupleTicketDrinks = 8; // Default couple ticket drinks
        let singleTicketDrinks = 4; // Default single ticket drinks
        let generatedTicketNumber = null; // Store the generated ticket number
        let hasReachedPaymentScreen = false; // Track if user has reached payment screen before
        let verificationCode = null; // Store the generated verification code
        
        // Function to generate a 5-digit random ticket number
        function generateTicketNumber() {
            return Math.floor(10000 + Math.random() * 90000);
        }
        
        // Function to generate a 6-digit random verification code
        function generateVerificationCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        // Function to fetch ticket prices from database
        async function fetchTicketPrices() {
            try {
                // Fetch both ticket types from winter_formal table
                const { data, error } = await supabase
                    .from('winter_formal')
                    .select('ticket_type, price, drinks_with_ticket')
                    .in('ticket_type', ['couple', 'single']);
                
                if (error) {
                    console.error('Error fetching ticket prices:', error);
                    return; // Keep default prices if fetch fails
                }
                
                if (data && data.length > 0) {
                    data.forEach(row => {
                        if (row.ticket_type === 'couple') {
                            coupleTicketPrice = parseFloat(row.price);
                            coupleTicketDrinks = parseInt(row.drinks_with_ticket);
                        } else if (row.ticket_type === 'single') {
                            singleTicketPrice = parseFloat(row.price);
                            singleTicketDrinks = parseInt(row.drinks_with_ticket);
                        }
                    });
                    
                    // Update ticket amount to match single ticket price
                    ticketAmount = singleTicketPrice;
                    
                    // Update the pricing display
                    updatePricingDisplay();
                }
                
            } catch (error) {
                console.error('Error fetching ticket prices:', error);
                // Keep default prices if fetch fails
            }
        }
        
        // Function to fetch event dates from database
        async function fetchEventDates() {
            try {
                // Fetch RSVP date from winter_formal table where date_label = "rsvp_date"
                const { data: rsvpData, error: rsvpError } = await supabase
                    .from('winter_formal')
                    .select('date')
                    .eq('date_label', 'rsvp_date')
                    .single();
                
                // Fetch event date from winter_formal table where date_label = "event_date"
                const { data: eventData, error: eventError } = await supabase
                    .from('winter_formal')
                    .select('date')
                    .eq('date_label', 'event_date')
                    .single();
                
                if (rsvpError || eventError) {
                    console.error('Error fetching event dates:', rsvpError || eventError);
                    return; // Keep default dates if fetch fails
                }
                
                const rspDate = rsvpData?.date || 'December 2nd @11:59pm';
                const eventDate = eventData?.date || 'Saturday December 6th @8pm';
                
                // Update the subtitle with fetched dates
                const subtitle = document.querySelector('.subtitle');
                if (subtitle) {
                    subtitle.innerHTML = `The event will be held indoors on ${eventDate} (825 East Washington Street). Attire is short dresses and suits. All Duncan seniors and juniors are welcome. Only select sophomores have been invited due to limited indoor capacity. <strong><u>RSVP by ${rspDate}</u></strong> before your spot is given to someone else.`;
                }
                
            } catch (error) {
                console.error('Error fetching event dates:', error);
                // Keep default dates if fetch fails
            }
        }
        
        // Function to update pricing display with fetched prices
        function updatePricingDisplay() {
            // Update pricing details text
            const pricingDetails = document.querySelector('.pricing-details');
            if (pricingDetails) {
                pricingDetails.innerHTML = `Tickets are priced based on an expected number of drinks. The prices below apply whether or not you or your guest plan to drink or arrive late to the event. <strong><u>There are no ticket price exceptions, so please do not ask for one.</u></strong> Tickets will be checked at the door.`;
            }
            
            // Update button text with drinks count
            const coupleButton = document.getElementById('coupleTicketBtn');
            if (coupleButton) {
                coupleButton.textContent = `Couple - ${coupleTicketDrinks} Drinks ($${coupleTicketPrice})`;
            }
            
            const singleButton = document.getElementById('singleTicketBtn');
            if (singleButton) {
                singleButton.textContent = `Single - ${singleTicketDrinks} Drinks ($${singleTicketPrice})`;
            }
        }
        
        // Function to show error message on screen
        function showErrorMessage(message, elementId) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    errorElement.classList.remove('show');
                }, 5000);
            }
        }
        
        // Function to increment messages_sent counter in duncan_compound_overview table
        async function incrementMessagesSent() {
            try {
                
                const { data, error } = await supabase
                    .from('duncan_compound_overview')
                    .select('messages_sent')
                    .single();
                
                if (error) {
                    console.error('Error fetching current messages_sent count:', error);
                    return false;
                }
                
                const currentCount = data.messages_sent || 0;
                const newCount = currentCount + 1;
                
                const { error: updateError } = await supabase
                    .from('duncan_compound_overview')
                    .update({ messages_sent: newCount })
                    .eq('id', 1); // Assuming there's a single row with id=1
                
                if (updateError) {
                    console.error('Error updating messages_sent counter:', updateError);
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Error incrementing messages_sent counter:', error);
                return false;
            }
        }
        
        // Function to send SMS using Textbelt API
        async function sendSMS(phoneNumber, message) {
            try {
                
                // Create a form and submit it to bypass CORS
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'https://textbelt.com/text';
                form.target = 'hiddenFrame';
                
                const phoneInput = document.createElement('input');
                phoneInput.type = 'hidden';
                phoneInput.name = 'phone';
                phoneInput.value = phoneNumber;
                
                const messageInput = document.createElement('input');
                messageInput.type = 'hidden';
                messageInput.name = 'message';
                messageInput.value = message;
                
                const keyInput = document.createElement('input');
                keyInput.type = 'hidden';
                keyInput.name = 'key';
                keyInput.value = '45debba6c3c5d9cad3f4c8ca12acb0b88b985490KTZaeiFqRnvU5RonIZArQHyVA';
                
                form.appendChild(phoneInput);
                form.appendChild(messageInput);
                form.appendChild(keyInput);
                
                // Create hidden iframe to handle response
                const iframe = document.createElement('iframe');
                iframe.name = 'hiddenFrame';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                
                // Handle response
                return new Promise((resolve, reject) => {
                    iframe.onload = function() {
                        try {
                            const responseText = iframe.contentDocument.body.textContent;
                            const result = JSON.parse(responseText);
                            
                            if (result.success) {
                                
                                // Increment messages_sent counter
                                incrementMessagesSent().then(success => {
                                    if (success) {
                                    } else {
                                        console.warn('Failed to increment messages sent counter, but SMS was sent');
                                    }
                                });
                                
                                resolve({ success: true, textId: result.textId });
                            } else {
                                console.error('SMS failed:', result.error);
                                reject(new Error(result.error));
                            }
                        } catch (e) {
                            
                            // Increment messages_sent counter even if response format varies
                            incrementMessagesSent().then(success => {
                                if (success) {
                                } else {
                                    console.warn('Failed to increment messages sent counter, but SMS was sent');
                                }
                            });
                            
                            resolve({ success: true });
                        }
                        
                        // Clean up
                        document.body.removeChild(iframe);
                    };
                    
                    iframe.onerror = function() {
                        console.error('SMS request failed');
                        document.body.removeChild(iframe);
                        reject(new Error('SMS request failed'));
                    };
                    
                    document.body.appendChild(form);
                    form.submit();
                    document.body.removeChild(form);
                });
                
            } catch (error) {
                console.error('Error sending SMS:', error);
                throw error;
            }
        }
        
        // Function to check if ticket number exists in the database
        async function checkTicketNumberExists(ticketNumber) {
            try {
                const { data, error } = await supabase
                    .from('winter_formal_orders')
                    .select('ticket_number')
                    .eq('ticket_number', ticketNumber)
                    .maybeSingle();
                
                if (error) {
                    console.error('Error checking ticket number:', error);
                    return false; // Assume it doesn't exist if there's an error
                }
                
                return data !== null; // If data exists, ticket number is taken
            } catch (error) {
                console.error('Error checking ticket number:', error);
                return false; // Assume it doesn't exist if there's an error
            }
        }
        
        // Function to generate a unique ticket number
        async function generateUniqueTicketNumber() {
            let attempts = 0;
            const maxAttempts = 100; // Prevent infinite loop
            
            while (attempts < maxAttempts) {
                const ticketNumber = generateTicketNumber();
                const exists = await checkTicketNumberExists(ticketNumber);
                
                if (!exists) {
                    return ticketNumber;
                }
                
                attempts++;
            }
            
            console.error('Failed to generate unique ticket number after', maxAttempts, 'attempts');
            return null;
        }
        
        // Function to generate ticket number in the background after page load
        async function generateTicketNumberInBackground() {
            try {
                generatedTicketNumber = await generateUniqueTicketNumber();
                
                if (generatedTicketNumber) {
                    // Update the view ticket button with the actual ticket number
                    const viewTicketButton = document.getElementById('viewTicketButton');
                    if (viewTicketButton) {
                        viewTicketButton.textContent = `View Your Ticket (#${generatedTicketNumber})`;
                    }
                } else {
                    console.error('Failed to generate ticket number');
                }
            } catch (error) {
                console.error('Error generating ticket number:', error);
            }
        }
        
        // Function to format timestamp as ISO 8601 string for database
        function formatTimestamp() {
            return new Date().toISOString();
        }
        
        // Function to get current user data
        function getUserData() {
            const fullName = document.getElementById('fullName')?.value?.trim() || '';
            const emailAddress = document.getElementById('emailAddress')?.value?.trim() || '';
            const timestamp = formatTimestamp();
            
            return {
                ticket_number: generatedTicketNumber,
                name: fullName,
                email: emailAddress,
                ticket_type: selectedTicketType,
                expected_amount: ticketAmount,
                timestamp: timestamp
            };
        }
        
        // Function to save user data to the database
        async function saveUserData() {
            if (!generatedTicketNumber) {
                console.error('No ticket number available to save data');
                return false;
            }
            
            const userData = getUserData();
            
            // Check if all required data is available
            if (!userData.name || !userData.email) {
                console.error('Missing required user data:', userData);
                return false;
            }
            
            try {
                
                // First, check if a record with this ticket number already exists
                const { data: existingData, error: checkError } = await supabase
                    .from('winter_formal_orders')
                    .select('ticket_number')
                    .eq('ticket_number', generatedTicketNumber)
                    .maybeSingle();
                
                if (checkError) {
                    console.error('Error checking existing record:', checkError);
                    return false;
                }
                
                let result;
                if (existingData) {
                    // Update existing record
                    result = await supabase
                        .from('winter_formal_orders')
                        .update({
                            name: userData.name,
                            email: userData.email,
                            ticket_type: userData.ticket_type,
                            expected_amount: userData.expected_amount,
                            timestamp: userData.timestamp,
                            payment_approved: 'pending'
                        })
                        .eq('ticket_number', generatedTicketNumber);
                } else {
                    // Insert new record
                    const userDataWithPaymentStatus = {
                        ...userData,
                        payment_approved: 'pending'
                    };
                    result = await supabase
                        .from('winter_formal_orders')
                        .insert([userDataWithPaymentStatus]);
                }
                
                if (result.error) {
                    console.error('Error saving user data:', result.error);
                    return false;
                }
                
               
                return true;
            } catch (error) {
                console.error('Error saving user data:', error);
                return false;
            }
        }
        
        // Get the pricing screen and button elements
        const pricingScreen = document.getElementById('pricingScreen');
        const howToPayScreen = document.getElementById('howToPayScreen');
        const nameEntryScreen = document.getElementById('nameEntryScreen');
        const emailEntryScreen = document.getElementById('emailEntryScreen');
        const verificationScreen = document.getElementById('verificationScreen');
        const completePaymentScreen = document.getElementById('completePaymentScreen');
        const payForOtherScreen = document.getElementById('payForOtherScreen');
        const continueBtn = document.getElementById('rsvpYes');
        const backButton = document.getElementById('backButton');
        const coupleTicketBtn = document.getElementById('coupleTicketBtn');
        const singleTicketBtn = document.getElementById('singleTicketBtn');
        const backFromHowToPay = document.getElementById('backFromHowToPay');
        const proceedToPayment = document.getElementById('proceedToPayment');
        const payForOtherNow = document.getElementById('payForOtherNow');
        const backFromNameEntry = document.getElementById('backFromNameEntry');
        const backFromEmailEntry = document.getElementById('backFromEmailEntry');
        const backFromVerification = document.getElementById('backFromVerification');
        const backFromCompletePayment = document.getElementById('backFromCompletePayment');
        const launchVenmo = document.getElementById('launchVenmo');
        
        // Store data for pay for other flow
        let payForOtherData = null;
        let cameFromShareFlow = false; // Track if user came from share flow

        // Show pricing screen when "Yes" button is clicked
        continueBtn.addEventListener('click', function() {
            pricingScreen.style.display = 'block';
        });

        // Hide pricing screen when back button is clicked
        backButton.addEventListener('click', function() {
            pricingScreen.style.display = 'none';
        });

        // Show Name Entry screen when either ticket button is clicked
        coupleTicketBtn.addEventListener('click', function() {
            selectedTicketType = 'couple';
            ticketAmount = coupleTicketPrice;
            pricingScreen.style.display = 'none';
            nameEntryScreen.style.display = 'block';
            
            // If user has reached payment screen before, mark that data needs updating
            if (hasReachedPaymentScreen) {
            }
        });

        singleTicketBtn.addEventListener('click', function() {
            selectedTicketType = 'single';
            ticketAmount = singleTicketPrice;
            pricingScreen.style.display = 'none';
            nameEntryScreen.style.display = 'block';
            
            // If user has reached payment screen before, mark that data needs updating
            if (hasReachedPaymentScreen) {
            }
        });

        // Hide How To Pay screen when back button is clicked
        backFromHowToPay.addEventListener('click', function() {
            howToPayScreen.style.display = 'none';
            emailEntryScreen.style.display = 'block';
        });

        // Show Complete Payment screen when "I'm Paying With Venmo" button is clicked
        proceedToPayment.addEventListener('click', function() {
            cameFromShareFlow = false; // User is paying themselves
            howToPayScreen.style.display = 'none';
            completePaymentScreen.style.display = 'block';
            handleCompletePaymentScreenShow();
            
            // Update complete payment description with correct amount
            const completePaymentDescription = document.getElementById('completePaymentDescription');
            if (completePaymentDescription) {
                completePaymentDescription.innerHTML = 'Follow the steps below to pay the $' + ticketAmount + ' amount. '
            }
        });

        // Function to detect if user is on an Apple device
        function isAppleDevice() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            return /iPad|iPhone|iPod|Macintosh/.test(userAgent) && !window.MSStream;
        }

        // Function to check if Web Share API is available
        function canUseWebShare() {
            return navigator.share !== undefined;
        }

        // Function to share using native Apple share sheet
        async function shareViaApple() {
            const shareLink = getShareLink();
            
            try {
                if (navigator.share) {
                    await navigator.share({
                        url: shareLink
                    });
                } else {
                    // Fallback: if share API not available, show message
                    alert('Share functionality is not available on this device. Please use the "Copy Payment Link" option below.');
                }
            } catch (error) {
                // User cancelled - don't do anything
                if (error.name === 'AbortError') {
                    return;
                }
                // Other errors - don't fall back to clipboard, just log
                console.error('Error sharing:', error);
            }
        }

        // Function to toggle "Someone is Venmoing For Me" dropdown
        function toggleSomeonePayingForMe() {
            const someonePayingForMeSection = document.getElementById('someonePayingForMeSection');
            const dropdownButton = document.getElementById('someonePayingForMeButton');
            
            if (someonePayingForMeSection.style.display === 'none' || !someonePayingForMeSection.style.display) {
                someonePayingForMeSection.style.display = 'block';
            } else {
                someonePayingForMeSection.style.display = 'none';
            }
        }


        // Handle "Pay For Other Now" button click
        payForOtherNow.addEventListener('click', async function() {
            if (payForOtherData) {
                // Set the ticket data from the pay for other data
                selectedTicketType = payForOtherData.ticketType;
                ticketAmount = payForOtherData.ticketType === 'couple' ? coupleTicketPrice : singleTicketPrice;
                
                // Update the form fields with the other person's data (if they exist)
                const nameInput = document.getElementById('fullName');
                const emailInput = document.getElementById('emailAddress');
                if (nameInput) nameInput.value = payForOtherData.name;
                if (emailInput) emailInput.value = payForOtherData.email;
                
                // Generate a ticket number for this payment
                await generateTicketNumberInBackground();
                
                // Mark that this came from pay for other flow (not share flow)
                cameFromShareFlow = false;
                
                // Hide pay for other screen and show complete payment screen
                payForOtherScreen.style.display = 'none';
                completePaymentScreen.style.display = 'block';
                handleCompletePaymentScreenShow();
                
                // Update complete payment description with correct amount
                const completePaymentDescription = document.getElementById('completePaymentDescription');
                if (completePaymentDescription) {
                    completePaymentDescription.innerHTML = 'Follow the steps below to pay the $' + ticketAmount + ' amount. '
                }
            }
        });

        // Hide Name Entry screen when back button is clicked
        backFromNameEntry.addEventListener('click', function() {
            nameEntryScreen.style.display = 'none';
            pricingScreen.style.display = 'block';
        });

        // Hide Email Entry screen when back button is clicked
        backFromEmailEntry.addEventListener('click', function() {
            emailEntryScreen.style.display = 'none';
            nameEntryScreen.style.display = 'block';
        });

        // Hide Verification screen when back button is clicked
        backFromVerification.addEventListener('click', function() {
            verificationScreen.style.display = 'none';
            emailEntryScreen.style.display = 'block';
        });

        // Hide Complete Payment screen when back button is clicked
        backFromCompletePayment.addEventListener('click', function() {
            completePaymentScreen.style.display = 'none';
            
            // If user came from share flow, go back to share section
            if (cameFromShareFlow) {
                howToPayScreen.style.display = 'block';
                // Show the share section and expand it
                const someonePayingForMeSection = document.getElementById('someonePayingForMeSection');
                if (someonePayingForMeSection) {
                    someonePayingForMeSection.style.display = 'block';
                }
                cameFromShareFlow = false; // Reset flag
            } else if (payForOtherData) {
                // If came from pay for other screen, go back there
                payForOtherScreen.style.display = 'block';
            } else {
                // Otherwise go back to how to pay screen
                howToPayScreen.style.display = 'block';
            }
        });
        
        // Function to handle when user reaches complete payment screen (for updates)
        function handleCompletePaymentScreenShow() {
            // Save/update user data when reaching complete payment screen
            saveUserData().then(success => {
                if (success) {
                } else {
                    console.error('Failed to update user data');
                }
            });
            
            // Start monitoring payment status as soon as payment screen is shown
            startPaymentStatusMonitoring();
        }

        // Handle Venmo launch button
        launchVenmo.addEventListener('click', function() {
            showVenmoPopup();
        });

        // Show Venmo popup
        function showVenmoPopup() {
            console.log('showVenmoPopup called');
            const popup = document.getElementById('venmoPopupOverlay');
            if (popup) {
                // Set all styles first
                popup.style.zIndex = '2000';
                popup.style.pointerEvents = 'auto';
                popup.style.display = 'flex';
                
                // Ensure popup content is also clickable
                const popupContent = popup.querySelector('.venmo-popup');
                if (popupContent) {
                    popupContent.style.pointerEvents = 'auto';
                    popupContent.style.zIndex = '2001';
                }
                // Ensure buttons are clickable and re-attach event listeners
                const popupButton = popup.querySelector('.venmo-popup-button');
                const popupClose = popup.querySelector('.venmo-popup-close');
                if (popupButton) {
                    popupButton.style.pointerEvents = 'auto';
                    popupButton.style.zIndex = '2002';
                    popupButton.style.cursor = 'pointer';
                    // Remove existing listeners and re-attach to ensure they work
                    const newButton = popupButton.cloneNode(true);
                    popupButton.parentNode.replaceChild(newButton, popupButton);
                    newButton.addEventListener('click', function(e) {
                        console.log('Button click handler fired');
                        e.preventDefault();
                        e.stopPropagation();
                        closeVenmoPopup();
                        launchVenmoApp();
                    }, { passive: false });
                    newButton.addEventListener('touchend', function(e) {
                        console.log('Button touchend handler fired');
                        e.preventDefault();
                        e.stopPropagation();
                        closeVenmoPopup();
                        launchVenmoApp();
                    }, { passive: false });
                }
                if (popupClose) {
                    popupClose.style.pointerEvents = 'auto';
                    popupClose.style.zIndex = '2002';
                    popupClose.style.cursor = 'pointer';
                    // Remove existing listeners and re-attach to ensure they work
                    const newClose = popupClose.cloneNode(true);
                    popupClose.parentNode.replaceChild(newClose, popupClose);
                    newClose.addEventListener('click', function(e) {
                        console.log('Close click handler fired');
                        e.preventDefault();
                        e.stopPropagation();
                        closeVenmoPopup();
                    }, { passive: false });
                    newClose.addEventListener('touchend', function(e) {
                        console.log('Close touchend handler fired');
                        e.preventDefault();
                        e.stopPropagation();
                        closeVenmoPopup();
                    }, { passive: false });
                }
                // Force a reflow to ensure the popup is rendered
                popup.offsetHeight;
                console.log('Popup shown');
            } else {
                console.error('Popup element not found');
            }
        }

        // Close Venmo popup - make it globally accessible
        window.closeVenmoPopup = function closeVenmoPopup() {
            console.log('closeVenmoPopup called');
            const popup = document.getElementById('venmoPopupOverlay');
            if (popup) {
                popup.style.display = 'none';
                console.log('Popup closed');
            } else {
                console.error('Popup element not found');
            }
        };

        // Launch Venmo with proper link - make it globally accessible
        window.launchVenmoApp = function launchVenmoApp() {
            console.log('launchVenmoApp called');
            const ticketNumber = generatedTicketNumber || '42821';
            const venmoUrl = `venmo://paycharge?txn=pay&recipients=duncanoffcampus&amount=${ticketAmount}&note=Winter%20Formal%20(%23${ticketNumber})`;
            console.log('Venmo URL:', venmoUrl);
            console.log('ticketAmount:', ticketAmount);
            window.location.href = venmoUrl;
        };

        // Show payment received screen
        async function showPaymentReceivedScreen() {
            const completePaymentScreen = document.getElementById('completePaymentScreen');
            const paymentReceivedScreen = document.getElementById('paymentReceivedScreen');
            
            completePaymentScreen.style.display = 'none';
            paymentReceivedScreen.style.display = 'block';
            
            // Update the view ticket button with the actual ticket number
            const viewTicketButton = document.getElementById('viewTicketButton');
            if (viewTicketButton) {
                viewTicketButton.textContent = `View Your Ticket (#${generatedTicketNumber})`;
            }
            
            // Only send SMS if SEND_TICKET_TEXT is enabled
            if (SEND_TICKET_TEXT) {
                // Get user data to access phone number
                const userData = getUserData();
                
                // Call the server to approve payment and send SMS
                try {
                    const response = await fetch('/api/approve-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ticket_number: generatedTicketNumber
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                    } else {
                        console.error('Failed to approve payment:', result.error);
                    }
                } catch (error) {
                    console.error('Error calling approve-payment API:', error);
                }
            } else {
            }
        }

        // Start monitoring payment status
        function startPaymentStatusMonitoring() {
            if (!generatedTicketNumber) {
                console.error('No ticket number available for payment monitoring');
                return;
            }

            // Wait a moment for the database record to be created
            setTimeout(() => {
                // Check payment status every second
                const interval = setInterval(async () => {
                    try {
                        const { data, error } = await supabase
                            .from('winter_formal_orders')
                            .select('payment_approved')
                            .eq('ticket_number', generatedTicketNumber)
                            .maybeSingle();
                        
                        if (error) {
                            console.error('Error checking payment status:', error);
                            return;
                        }
                        
                        if (data && data.payment_approved === 'approved') {
                            clearInterval(interval);
                            showPaymentReceivedScreen();
                        }
                    } catch (error) {
                        console.error('Error in payment status monitoring:', error);
                    }
                }, 1000); // Check every second
            }, 2000); // Wait 2 seconds before starting monitoring
        }

        // Name handling functions
        function handleNameSubmit(event) {
            event.preventDefault();
            const fullName = document.getElementById('fullName').value.trim();
            
            // Check if there's a space and at least 2 characters after it (last name)
            const nameParts = fullName.split(' ');
            const hasLastName = nameParts.length >= 2 && nameParts[nameParts.length - 1].length >= 2;
            
            if (hasLastName) {
                // Store name (in a real app, this would be sent to a server)
                
                // Show email entry screen
                nameEntryScreen.style.display = 'none';
                emailEntryScreen.style.display = 'block';
            } else {
                alert('Please enter your first and last name (last name must be at least 2 characters)');
            }
        }

        // Email handling functions
        function handleEmailSubmit(event) {
            event.preventDefault();
            const emailAddress = document.getElementById('emailAddress').value.trim();
            
            // Basic email validation - must contain @ and .
            if (emailAddress.includes('@nd.edu')) {
                // Store email (in a real app, this would be sent to a server)
                
                // Go directly to How To Pay screen (no phone entry, so no OTP verification)
                emailEntryScreen.style.display = 'none';
                howToPayScreen.style.display = 'block';
                
                // Mark that user has reached payment screen
                hasReachedPaymentScreen = true;
                
                // Fallback text is now hardcoded - no longer updating dynamically
                
                // Update copy content with correct amount and ticket number
                const venmoMessageContent = document.getElementById('venmoMessageContent');
                if (venmoMessageContent) {
                    const ticketNumber = generatedTicketNumber || '42821';
                    venmoMessageContent.textContent = `Winter Formal (#${ticketNumber})`;
                }
                
                // Update complete payment description with correct amount
                const completePaymentDescription = document.getElementById('completePaymentDescription');
                if (completePaymentDescription) {
                    completePaymentDescription.innerHTML = `Clicking the button below will launch Venmo with a pre-populated note and the $${ticketAmount} amount. Please do not modify these values. <strong><u>You will receive an email with your ticket once we confirm your Venmo payment. This could take a few hours. REMEMBER TO CHECK YOUR EMAIL SPAM.</u></strong>`;
                }
            } else {
                showErrorMessage('Please enter an email ending in @nd.edu', 'emailErrorMessage');
            }
        }

        function handleVerificationSubmit(event) {
            event.preventDefault();
            const enteredCode = document.getElementById('verificationCode').value;
            
            // Basic verification code validation
            if (enteredCode.length === 6 && /^\d{6}$/.test(enteredCode)) {
                // Check if the entered code matches the generated code
                if (enteredCode === verificationCode) {
                    // Store verification code (in a real app, this would be sent to a server)
                    
                    // Show How To Pay screen
                    verificationScreen.style.display = 'none';
                    howToPayScreen.style.display = 'block';
                    
                    // Mark that user has reached payment screen
                    hasReachedPaymentScreen = true;
                    
                    // Fallback text is now hardcoded - no longer updating dynamically
                    
                    // Update copy content with correct amount and ticket number
                    const venmoMessageContent = document.getElementById('venmoMessageContent');
                    if (venmoMessageContent) {
                        const ticketNumber = generatedTicketNumber || '42821';
                        venmoMessageContent.textContent = `Winter Formal (#${ticketNumber})`;
                    }
                    
                    // Update complete payment description with correct amount
                    const completePaymentDescription = document.getElementById('completePaymentDescription');
                    if (completePaymentDescription) {
                        completePaymentDescription.innerHTML = `Clicking the button below will launch Venmo with a pre-populated note and the $${ticketAmount} amount. Please do not modify these values. <strong><u>You will receive a text with your ticket once we confirm your Venmo payment.</u></strong>`;
                    }
                } else {
                    showErrorMessage('Invalid verification code. Please check the code sent to your phone.', 'verificationErrorMessage');
                }
            } else {
                showErrorMessage('Please enter a valid 6-digit verification code', 'verificationErrorMessage');
            }
        }

        function validateName() {
            const nameInput = document.getElementById('fullName');
            const submitButton = document.getElementById('submitNameButton');
            const name = nameInput.value.trim();
            
            // Check if there's a space and at least 2 characters after it (last name)
            const nameParts = name.split(' ');
            const hasLastName = nameParts.length >= 2 && nameParts[nameParts.length - 1].length >= 2;
            
            if (hasLastName) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        }

        function validateVerificationCode() {
            const verificationInput = document.getElementById('verificationCode');
            const verifyButton = document.getElementById('verifyButton');
            const verificationCode = verificationInput.value;
            
            if (verificationCode.length === 6 && /^\d{6}$/.test(verificationCode)) {
                verifyButton.disabled = false;
                // Dismiss keyboard after 6th digit
                verificationInput.blur();
            } else {
                verifyButton.disabled = true;
            }
        }

        function validateEmail() {
            const emailInput = document.getElementById('emailAddress');
            const submitButton = document.getElementById('submitEmailButton');
            const email = emailInput.value.trim();
            
            // Check if email contains @ and .
            if (email.includes('@') && email.includes('.')) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        }

        // Mobile detection function
        function isMobileDevice() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Consider it mobile only if it's a mobile device (no screen size check)
            return isMobile;
        }

        // Show appropriate screen after device detection
        function showAppropriateScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            const mobileDetectionScreen = document.getElementById('mobileDetectionScreen');
            const appContainer = document.querySelector('.app-container');
            
            // Hide loading screen
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            
            // Check if override is enabled
            if (OVERRIDE_MOBILE_POPUP) {
                // Override: show app container and hide mobile detection screen
                if (mobileDetectionScreen) {
                    mobileDetectionScreen.style.display = 'none';
                }
                if (appContainer) {
                    appContainer.style.display = 'block';
                }
            } else if (isMobileDevice()) {
                // Hide mobile detection screen for mobile users or when overridden
                if (mobileDetectionScreen) {
                    mobileDetectionScreen.style.display = 'none';
                }
                if (appContainer) {
                    appContainer.style.display = 'block';
                }
            } else {
                // Show mobile detection screen for desktop users
                if (mobileDetectionScreen) {
                    mobileDetectionScreen.style.display = 'block';
                }
                if (appContainer) {
                    appContainer.style.display = 'none';
                }
            }
        }

        // Add event listeners when the page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Check for pay for other parameters first
            const isPayForOther = await checkPayForOtherParams();
            if (isPayForOther) {
                return; // Don't show normal flow if pay for other is active
            }
            
            // Add a small delay to ensure loading screen is visible
            setTimeout(() => {
                showAppropriateScreen();
            }, 100);
            
            // Mobile override link removed - no longer using localStorage
            
            // Fetch ticket prices from database
            fetchTicketPrices();
            
            // Fetch event dates from database
            fetchEventDates();
            
            // Generate ticket number in the background
            generateTicketNumberInBackground();
            
            const nameInput = document.getElementById('fullName');
            const emailInput = document.getElementById('emailAddress');
            const verificationInput = document.getElementById('verificationCode');
            
            // Venmo popup event listeners
            const venmoPopupButton = document.getElementById('venmoPopupButton');
            const venmoPopupClose = document.getElementById('venmoPopupClose');
            const venmoPopupOverlay = document.getElementById('venmoPopupOverlay');
            
            if (venmoPopupButton) {
                // Use both click and touchstart for better mobile support
                const handleVenmoButtonClick = function(e) {
                    console.log('Venmo button clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                        closeVenmoPopup();
                        launchVenmoApp();
                    } catch (error) {
                        console.error('Error in venmo button handler:', error);
                    }
                };
                venmoPopupButton.addEventListener('click', handleVenmoButtonClick, { passive: false });
                venmoPopupButton.addEventListener('touchend', handleVenmoButtonClick, { passive: false });
                // Also add mousedown as backup
                venmoPopupButton.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                });
            }
            
            if (venmoPopupClose) {
                // Use both click and touchstart for better mobile support
                const handleCloseClick = function(e) {
                    console.log('Close button clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                        closeVenmoPopup();
                    } catch (error) {
                        console.error('Error in close button handler:', error);
                    }
                };
                venmoPopupClose.addEventListener('click', handleCloseClick, { passive: false });
                venmoPopupClose.addEventListener('touchend', handleCloseClick, { passive: false });
                // Also add mousedown as backup
                venmoPopupClose.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                });
            }
            
            if (venmoPopupOverlay) {
                venmoPopupOverlay.addEventListener('click', function(e) {
                    if (e.target === venmoPopupOverlay) {
                        e.preventDefault();
                        e.stopPropagation();
                        closeVenmoPopup();
                    }
                });
            }
            
            // Prevent clicks on popup content from closing the popup
            const venmoPopup = document.querySelector('.venmo-popup');
            if (venmoPopup) {
                venmoPopup.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }

            // Payment received screen event listeners
            const viewTicketButton = document.getElementById('viewTicketButton');
            
            if (viewTicketButton) {
                viewTicketButton.addEventListener('click', function() {
                    // Navigate to the unique ticket page
                    const ticketNumber = generatedTicketNumber || '11111';
                    window.location.href = `/ticket/${ticketNumber}`;
                });
            }

            
            if (nameInput) {
                nameInput.addEventListener('input', function() {
                    validateName();
                    // If user has reached payment screen before, mark that data needs updating
                    if (hasReachedPaymentScreen) {
                    }
                });
                // Validate pre-populated name on page load
                validateName();
            }

            if (emailInput) {
                emailInput.addEventListener('input', function() {
                    validateEmail();
                    // If user has reached payment screen before, mark that data needs updating
                    if (hasReachedPaymentScreen) {
                    }
                });
                // Validate pre-populated email on page load
                validateEmail();
            }
            
            if (verificationInput) {
                verificationInput.addEventListener('input', function() {
                    validateVerificationCode();
                });
                
                // Handle automatic code detection from SMS
                verificationInput.addEventListener('paste', function(e) {
                    // Allow the paste to complete, then validate
                    setTimeout(() => {
                        validateVerificationCode();
                    }, 0);
                });
                
                // Handle automatic code detection from iOS
                verificationInput.addEventListener('change', function() {
                    validateVerificationCode();
                });
                
                // Validate pre-populated verification code on page load
                validateVerificationCode();
            }
        });

        // Copy to clipboard function
        function copyToClipboard(text, copyBox) {
            // Store original label opacity before modifying
            const label = copyBox.querySelector('.copy-label');
            const originalOpacity = label ? (copyBox.classList.contains('simple') ? '0.9' : '0.7') : null;
            
            navigator.clipboard.writeText(text).then(function() {
                // Hide the original content and label, show "Text Copied"
                const content = copyBox.querySelector('.copy-content');
                const feedback = copyBox.querySelector('.copy-feedback');
                
                if (content) content.classList.add('hidden');
                if (label) {
                    label.classList.add('hidden');
                }
                if (feedback) feedback.classList.add('show');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    if (feedback) feedback.classList.remove('show');
                    if (content) content.classList.remove('hidden');
                    if (label) {
                        label.classList.remove('hidden');
                        // Force reflow and explicitly set opacity for mobile compatibility
                        label.offsetHeight; // Trigger reflow
                        if (originalOpacity) {
                            label.style.opacity = originalOpacity;
                        }
                    }
                }, 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                } catch (fallbackErr) {
                    console.error('Fallback copy failed: ', fallbackErr);
                }
                
                document.body.removeChild(textArea);
                
                // Show feedback even for fallback
                const content = copyBox.querySelector('.copy-content');
                const feedback = copyBox.querySelector('.copy-feedback');
                
                if (content) content.classList.add('hidden');
                if (label) {
                    label.classList.add('hidden');
                }
                if (feedback) feedback.classList.add('show');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    if (feedback) feedback.classList.remove('show');
                    if (content) content.classList.remove('hidden');
                    if (label) {
                        label.classList.remove('hidden');
                        // Force reflow and explicitly set opacity for mobile compatibility
                        label.offsetHeight; // Trigger reflow
                        if (originalOpacity) {
                            label.style.opacity = originalOpacity;
                        }
                    }
                }, 2000);
            });
        }

        // Function to get the current Venmo message with dynamic ticket number
        function getVenmoMessage() {
            const ticketNumber = generatedTicketNumber || '42821';
            return `Winter Formal (#${ticketNumber})`;
        }

        // Function to generate share link for pay for other
        function getShareLink() {
            const name = document.getElementById('fullName')?.value?.trim() || '';
            const email = document.getElementById('emailAddress')?.value?.trim() || '';
            const ticketType = selectedTicketType || 'single';
            
            const baseUrl = window.location.origin + window.location.pathname;
            const params = new URLSearchParams({
                payForOther: 'true',
                name: name,
                email: email,
                ticketType: ticketType
            });
            
            return `${baseUrl}?${params.toString()}`.trim();
        }

        // Function to check URL parameters and show pay for other screen if needed
        async function checkPayForOtherParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const payForOther = urlParams.get('payForOther');
            
            if (payForOther === 'true') {
                const name = urlParams.get('name');
                const email = urlParams.get('email');
                const ticketType = urlParams.get('ticketType');
                
                if (name && email && ticketType) {
                    // Ensure ticket prices are loaded first
                    await fetchTicketPrices();
                    
                    payForOtherData = {
                        name: name,
                        email: email,
                        ticketType: ticketType
                    };
                    
                    // Show pay for other screen
                    const firstName = payForOtherData.name.split(' ')[0];
                    document.getElementById('payForOtherTitle').innerHTML = `You're Paying for<br>${firstName}'s Ticket`;
                    document.getElementById('payForOtherName').textContent = payForOtherData.name;
                    document.getElementById('payForOtherEmail').textContent = payForOtherData.email;
                    
                    const amount = ticketType === 'couple' ? coupleTicketPrice : singleTicketPrice;
                    const ticketTypeText = ticketType === 'couple' ? `Couple Ticket ($${amount})` : `Single Ticket ($${amount})`;
                    document.getElementById('payForOtherTicketType').textContent = ticketTypeText;
                    
                    document.getElementById('payForOtherNow').textContent = `Pay Now With Venmo`;
                    
                    // Remove query parameters from URL after reading them
                    const cleanUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                    
                    // Hide all other screens and show pay for other screen
                    const appContainer = document.querySelector('.app-container');
                    if (appContainer) appContainer.style.display = 'none';
                    const loadingScreen = document.getElementById('loadingScreen');
                    if (loadingScreen) loadingScreen.style.display = 'none';
                    const mobileDetectionScreen = document.getElementById('mobileDetectionScreen');
                    if (mobileDetectionScreen) mobileDetectionScreen.style.display = 'none';
                    payForOtherScreen.style.display = 'block';
                    
                    return true;
                }
            }
            return false;
        }

        // Function to toggle Venmo fallback section
        function toggleVenmoFallback() {
            const fallbackSection = document.getElementById('fallbackSection');
            const dropdownButton = document.getElementById('venmoFallbackLink');
            
            if (fallbackSection.style.display === 'none' || !fallbackSection.style.display) {
                fallbackSection.style.display = 'block';
                dropdownButton.classList.add('active');
            } else {
                fallbackSection.style.display = 'none';
                dropdownButton.classList.remove('active');
            }
        }
    </script>
</body>
</html>
